<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>QR Code ç”¢ç”Ÿå™¨</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1rem;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    p {
      font-size: 1rem;
      font-weight: bold;
      color: red;
      text-align: center;
      margin-bottom: 1rem;
    }

    form {
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    input, select, button {
      font-size: 1rem;
      padding: 0.5rem;
      width: 100%;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
/* === ç”Ÿæˆ QR Code æŒ‰éˆ•æ¨£å¼ï¼ˆå¦‚éœ€å¾®èª¿è«‹ä¿®æ”¹æ­¤å€å¡Šï¼‰ === */
    #barcodeForm button[type="button"] {
      width: auto;
      min-width: 200px;
      max-width: px;
      margin: 12px auto 0 auto;
      display: block;
      padding: 10px 0;
      font-size: 1rem;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      text-align: center;
    }

    /* === å…¨éƒ¨ä¸‹è¼‰æŒ‰éˆ•æ¨£å¼ï¼ˆå¦‚éœ€å¾®èª¿è«‹ä¿®æ”¹æ­¤å€å¡Šï¼‰ === */
    #downloadAllBtn {
      width: auto;
      min-width: 200px;
      max-width: 200px;
      margin: 12px auto 0 auto;
      display: block;
      padding: 10px 0;
      font-size: 1rem;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      text-align: center;
    }

    .qrcode-container {
      display: flex;
      flex-direction: column;   /* å‚ç›´æ’åˆ— */
      align-items: center;      /* ç½®ä¸­æ¯ä¸€å¼µ */
      gap: 1rem;
      width: 100%;
      max-width: 1000px;
      margin-top: 1rem;
    }

    .qr-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      background-color: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .barcode-description {
      font-size: 0.9rem;
      line-height: 1.4;
      margin-top: 0.5rem;
      word-break: break-all;
    }
    .barcode-description,
    .qr-wrapper div[style*="font-size: 16px"] {
  width: 150px;
  margin: 8px auto 0 auto;
  font-size: 16px;
  letter-spacing: 2px;
  text-align: center;
  line-height: 1.6;
  word-break: break-all;
  left: unset !important;
  transform: unset !important;
}

/* æ‰‹æ©Ÿç‰ˆæ¢ç¢¼å€å¡Šå¯¬åº¦è‡ªå‹•èª¿æ•´ä¸¦ç½®ä¸­ */
@media screen and (max-width: 600px) {
  .qr-wrapper {
    max-width: 95vw;
    width: 100%;
    align-items: center;
  }
  .barcode-description,
  .qr-wrapper div[style*="font-size: 16px"] {
    width: 100% !important;
    min-width: 0 !important;
    max-width: 100% !important;
    text-align: center !important;
    left: unset !important;
    transform: unset !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
}
    @media screen and (max-width: 600px) {
      .qr-wrapper {
        width: 100%;
        align-items: center;
      }
    }
      
    #downloadAllBtn {  
      width: auto;
      min-width: 100px;
      max-width: 200px;
      margin: 12px auto 0 auto;
      display: block;
      padding: 10px 0;
      font-size: 1rem;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      text-align: center;
    }

    #mainContent {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    /* è‡ªè¨‚éŒ¯èª¤è¨Šæ¯å½ˆçª—æ¨£å¼ */
#customAlert {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.2);
  justify-content: center;
  align-items: center;
}

#customAlert .alert-content {
  background: #fff;
  padding: 32px 24px;
  border-radius: 12px;
  box-shadow: 0 2px 16px #0002;
  max-width: 90vw;
  width: 100%;
}

#customAlertMsg {
  font-size: 1.2rem;
  white-space: pre-line;
  margin-bottom: 24px;
}

#customAlert button {
  font-size: 1rem;
  padding: 8px 32px;
  border-radius: 6px;
  background: #1976d2;
  color: #fff;
  border: none;
  cursor: pointer;
}

@media screen and (max-width: 600px) {
  .serial-number {
    top: 2px !important;
    right: 2px !important;
    font-size: 14px !important;
  }
}

.serial-number {
  position: absolute;
  top: 8px;
  right: 12px;
  font-weight: bold;
  font-size: 16px;
  color: #fff;
  background: #4CAF50;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2;
  box-shadow: 0 1px 4px #0002;
}
@media screen and (max-width: 600px) {
  .serial-number {
    top: 6px !important;
    right: 8px !important;
    font-size: 15px !important;
    width: 24px !important;
    height: 24px !important;
  }
}
.download-mode .barcode-description {
  display: none !important;
}
  </style>
</head>
<body>
    <!-- å·²ç§»é™¤ç™»å…¥å€å¡Š -->
      <div id="mainApp" style="display: block;">
        <div id="mainContent" style="width:100%;max-width:500px;margin:0 auto;">
          <div style="text-align: center; line-height: 1.8;">
      <p style="margin-bottom: 0.0em;">ğŸš€ <strong>ä½¿ç”¨é¢¨éšªæé†’</strong></p>
      <p style="margin: 0;">ä¿¡ç”¨å¡æ¢ç¢¼ç”¢ç”Ÿå™¨æœ‰å¯èƒ½æœƒç™¼ç”Ÿ</p>
      <p style="margin: 0;">æ¢ç¢¼æƒå¾—éä½†å¯¦éš›æ²’å…¥å¸³</p>
      <p style="margin: 0;">ä»˜æ¬¾ç´€éŒ„ã€Œé£›åˆ°å¤–å¤ªç©ºã€ä¸è¦‹äº†çš„æƒ…æ³</p>
      <p style="margin: 0;">è«‹å‹™å¿…ç¢ºèªæ¢ç¢¼å…§å®¹æ­£ç¢ºç„¡èª¤</p>
      <p style="margin-top: 0.0em;">âš ï¸ é€™äº›é¢¨éšªéœ€ç”±æ‚¨è‡ªè¡Œæ‰¿æ“”ï¼Œè«‹å°å¿ƒä½¿ç”¨</p>
        </div>
        <div style="font-size:0.95em;color:#555;margin-bottom:16px;">
          è¨»è§£1. å‰4ç¢¼ã€Œå¹´+æœˆã€æœ‰åœ‹æ³°ã€å¯Œé‚¦ã€è¯é‚¦<br>
          è¨»è§£2. å‰4ç¢¼ã€Œæœˆ+æ—¥ã€æœ‰ç‰å±±ã€å°æ–°ã€å°éŠ€
        </div>
    <h2>QR Code ç”¢ç”Ÿå™¨</h2>
    <form id="barcodeForm">
      <!-- ...åŸæœ¬è¡¨å–®å…§å®¹... -->
      <label>é¸æ“‡æ¢ç¢¼é¡å‹:</label>
      <select id="barcodeType">
        <option value="YYMM">å¹´+æœˆ</option>
        <option value="MMDD">æœˆ+æ—¥</option>
      </select>
      <label>ç¬¬ä¸€æ®µæ¢ç¢¼ (9ç¢¼)</label>
      <input type="text" id="firstBarcode" maxlength="9" pattern="[A-Za-z0-9]{9}" title="è«‹è¼¸å…¥ 9 ä½è‹±æ–‡æˆ–æ•¸å­—" required oninput="this.value=this.value.toUpperCase();clearQRCode()" />

      <label>ç¬¬äºŒæ®µæ¢ç¢¼ (16ç¢¼)
        <span style="margin-left:8px;">
          <span style="color: black;">(</span>
          <span style="color: blue;">éŠ·å¸³ç·¨è™Ÿ</span>
          <span style="color: black;">)</span>
        </span>
      </label>
           <input type="text" id="secondBarcode" maxlength="16" pattern="[A-Za-z0-9]{16}" 
  title="è«‹è¼¸å…¥ 16 ä½è‹±æ–‡æˆ–æ•¸å­—" required 
  oninput="this.value=this.value.toUpperCase();clearQRCode()" 
  placeholder="è«‹è¬¹æ…ç¢ºèª" style="color: #333;" />

      <label>ç¹³è²»æœŸé™ (YYYMMDD)</label>
      <input type="text" id="paymentDue" maxlength="7" pattern="^[0-9]{7}$" title="è«‹è¼¸å…¥æ­£ç¢ºæ ¼å¼ï¼ˆYYYMMDDï¼‰" required oninput="clearQRCode()" />

      <label>ç¹³è²»é‡‘é¡</label>
      <input type="text" id="paymentAmount" pattern="^[0-9]+$" title="è«‹è¼¸å…¥æ•¸å­—é‡‘é¡" required />
      <label>ç”Ÿæˆ QR Code æ•¸é‡:</label>
      <select id="qrCount">
        <option value="1">1</option>
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="30">30</option>
        <option value="40">40</option>
        <option value="50">50</option>
        <option value="60">60</option>
      </select>
      <button type="button" onclick="generateQRCode()">ç”Ÿæˆ QR Code</button>
    </form>
    <button type="button" id="downloadAllBtn" style="display:none;">å…¨éƒ¨ä¸‹è¼‰</button>
  </div>
  <div class="qrcode-container" id="qrcodeContainer" style="display: none;"></div>

  <!-- è‡ªè¨‚éŒ¯èª¤è¨Šæ¯å½ˆçª— -->
<div id="customAlert" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.2);justify-content:center;align-items:center;">
  <div style="background:#fff;padding:32px 24px;border-radius:12px;box-shadow:0 2px 16px #0002;max-width:90vw;">
    <div id="customAlertMsg" style="font-size:1.2rem;white-space:pre-line;margin-bottom:24px;"></div>
    <button onclick="closeCustomAlert()" style="font-size:1rem;padding:8px 32px;border-radius:6px;background:#1976d2;color:#fff;border:none;">ç¢ºå®š</button>
  </div>
</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
  // å­—æ¯è½‰æ•¸å­—
  function convertLettersToNumbers(text) {
    var result = "";
    for (var i = 0; i < text.length; i++) {
      var char = text.charAt(i);
      if (char >= 'A' && char <= 'Z') {
        result += convertLetterToNumber(char);
      } else if (!isNaN(char)) {
        result += char;
      }
    }
    return result;
  }
  function convertLetterToNumber(letter) {
    var mapping = {
      'A': '1', 'B': '2', 'C': '3', 'D': '4', 'E': '5',
      'F': '6', 'G': '7', 'H': '8', 'I': '9', 'J': '1',
      'K': '2', 'L': '3', 'M': '4', 'N': '5', 'O': '6',
      'P': '7', 'Q': '8', 'R': '9', 'S': '2', 'T': '3',
      'U': '4', 'V': '5', 'W': '6', 'X': '7', 'Y': '8', 'Z': '9'
    };
    return mapping[letter] || '0';
  }
  function calculateOddSum(barcode) {
    var sum = 0;
    for (var i = 0; i < barcode.length; i += 2) {
      var char = barcode.charAt(i);
      if (!isNaN(char)) {
        sum += parseInt(char, 10);
      }
    }
    return sum;
  }
  function calculateEvenSum(barcode) {
    var sum = 0;
    for (var i = 1; i < barcode.length; i += 2) {
      var char = barcode.charAt(i);
      if (!isNaN(char)) {
        sum += parseInt(char, 10);
      }
    }
    return sum;
  }
  // åªä¿ç•™é€™ä¸€å€‹ isValidMinguoDate
  function isValidMinguoDate(date) {
    if (!/^[0-9]{7}$/.test(date)) {
      return false;
    }
    const year = parseInt(date.substring(0, 3), 10) + 1911;
    const month = parseInt(date.substring(3, 5), 10);
    const day = parseInt(date.substring(5, 7), 10);

    if (month < 1 || month > 12) {
      return false;
    }

    const daysInMonth = new Date(year, month, 0).getDate();
    return day >= 1 && day <= daysInMonth;
  }

  // åªä¿ç•™é€™ä¸€å€‹ generateQRCode
  function generateQRCode() {
  const firstBarcode = document.getElementById("firstBarcode").value.trim();
  const secondBarcode = document.getElementById("secondBarcode").value.trim();
  const paymentDue = document.getElementById("paymentDue").value.trim();
  const paymentAmount = document.getElementById("paymentAmount").value.trim();
  const barcodeType = document.getElementById("barcodeType").value;
  const qrCount = parseInt(document.getElementById("qrCount").value);

  // å½™æ•´éŒ¯èª¤è¨Šæ¯
  let errorMsg = "";

  if (!/^[A-Z0-9]{9}$/.test(firstBarcode)) {
    errorMsg += "ç¬¬ä¸€æ®µæ¢ç¢¼å¿…é ˆç‚º9ä½è‹±æ•¸å­—ï¼\n";
  }
  if (!/^[A-Z0-9]{16}$/.test(secondBarcode)) {
    errorMsg += "ç¬¬äºŒæ®µæ¢ç¢¼å¿…é ˆç‚º16ä½è‹±æ•¸å­—ï¼\n";
  }
  if (!isValidMinguoDate(paymentDue)) {
    errorMsg += "ç¹³è²»æœŸé™æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æ­£ç¢ºçš„æ°‘åœ‹æ—¥æœŸ (YYYMMDD)\n";
  }

  if (errorMsg) {
    // ä½¿ç”¨è‡ªè¨‚çš„éŒ¯èª¤è¨Šæ¯å½ˆçª—
    document.getElementById("customAlertMsg").textContent = errorMsg.trim();
    document.getElementById("customAlert").style.display = "flex";

    // è‡ªå‹• focus ç¬¬ä¸€å€‹éŒ¯èª¤æ¬„ä½
    if (!/^[A-Z0-9]{9}$/.test(firstBarcode)) {
      document.getElementById('firstBarcode').focus();
    } else if (!/^[A-Z0-9]{16}$/.test(secondBarcode)) {
      document.getElementById('secondBarcode').focus();
    } else if (!isValidMinguoDate(paymentDue)) {
      document.getElementById('paymentDue').focus();
    }
    return;
  }

    const container = document.getElementById("qrcodeContainer");
    container.innerHTML = "";
    container.style.display = "flex";
    container.style.flexWrap = "wrap";
    container.style.justifyContent = "center";

    let currentDate = new Date(
      parseInt(paymentDue.substring(0, 3), 10) + 1911,
      parseInt(paymentDue.substring(3, 5), 10) - 1,
      parseInt(paymentDue.substring(5, 7), 10)
    );

    for (let i = 0; i < qrCount; i++) {
      let formattedDate;
      if (barcodeType === "YYMM") {
        if (i === 0) {
          formattedDate = paymentDue;
        } else {
          currentDate.setMonth(currentDate.getMonth() + 1);
          formattedDate =
            `${String(currentDate.getFullYear() - 1911).padStart(3, "0")}${String(currentDate.getMonth() + 1).padStart(2, "0")}01`;
        }
      } else {
        formattedDate =
          `${String(currentDate.getFullYear() - 1911).padStart(3, "0")}${String(currentDate.getMonth() + 1).padStart(2, "0")}${String(currentDate.getDate()).padStart(2, "0")}`;
        currentDate.setDate(currentDate.getDate() + 1);
      }

      const convertedFirst = convertLettersToNumbers(firstBarcode);
      const convertedSecond = convertLettersToNumbers(secondBarcode);
      const datePart = barcodeType === "YYMM" ? formattedDate.substring(1, 5) : formattedDate.substring(3);
      const paddedAmount = paymentAmount.padStart(9, "0");

      const oddSum = calculateOddSum(convertedFirst) + calculateOddSum(convertedSecond) + calculateOddSum(datePart + paddedAmount);
      const evenSum = calculateEvenSum(convertedFirst) + calculateEvenSum(convertedSecond) + calculateEvenSum(datePart + paddedAmount);

      const oddChecksum = oddSum % 11 === 0 ? "A" : oddSum % 11 === 10 ? "B" : oddSum % 11;
      const evenChecksum = evenSum % 11 === 0 ? "X" : evenSum % 11 === 10 ? "Y" : evenSum % 11;

      const thirdBarcode = datePart + oddChecksum + evenChecksum + paddedAmount;
      const qrData = `FAMI||{"bar1":"${firstBarcode}","bar2":"${secondBarcode}","bar3":"${thirdBarcode}","ID":"3A01"}`;

      const wrapper = document.createElement("div");
      wrapper.className = "qr-wrapper";
      wrapper.style.border = "1px solid #ccc";
      wrapper.style.borderRadius = "12px";
      wrapper.style.padding = "16px 12px 12px 12px";
      wrapper.style.margin = "12px";
      wrapper.style.backgroundColor = "#fff";
      wrapper.style.maxWidth = "320px";
      wrapper.style.width = "100%";
      wrapper.style.position = "relative";
      wrapper.style.boxSizing = "border-box";

      // æ¨™é¡Œ
      const title = document.createElement("div");
      title.textContent = "ç¹³æ¬¾æ¢ç¢¼";
      title.style.fontWeight = "bold";
      title.style.fontSize = "20px";
      title.style.letterSpacing = "2px";
      title.style.textAlign = "center";
      title.style.marginBottom = "10px";
      title.style.width = "100%";
      wrapper.appendChild(title);

      // æµæ°´è™Ÿï¼ˆå³ä¸Šè§’ï¼Œè®“ CSS æ§åˆ¶ä½ç½®ï¼‰
      const serialNumber = document.createElement("div");
      serialNumber.textContent = (i + 1);
      serialNumber.className = "serial-number";
      wrapper.appendChild(serialNumber);

      // QR åœ–æª”
      const qrDiv = document.createElement("div");
      qrDiv.style.margin = "0 auto";
      qrDiv.style.alignSelf = "center";
      qrDiv.style.width = "150px";
      new QRCode(qrDiv, { text: qrData, width: 150, height: 150 });
      wrapper.appendChild(qrDiv);

      // æ¢ç¢¼ä¸‰æ®µèªªæ˜ï¼ˆåŠ ä¸Š barcode-description classï¼‰
      const barcodeTextDiv = document.createElement("div");
      barcodeTextDiv.className = "barcode-description";
      barcodeTextDiv.style.display = "flex";
      barcodeTextDiv.style.flexDirection = "column";
      barcodeTextDiv.style.alignItems = "flex-start";
      barcodeTextDiv.style.margin = "8px auto 0 auto";
      barcodeTextDiv.style.fontSize = "13px";
      barcodeTextDiv.style.letterSpacing = "2px";
      barcodeTextDiv.style.textAlign = "left";
      barcodeTextDiv.style.lineHeight = "1.6";
      barcodeTextDiv.style.width = "150px";
      barcodeTextDiv.innerHTML = `
        <div style="text-align:left;width:100%;">${firstBarcode}</div>
        <div style="text-align:left;width:100%;">${secondBarcode}</div>
        <div style="text-align:left;width:100%;">${thirdBarcode}</div>
      `;
      wrapper.appendChild(barcodeTextDiv);

      container.appendChild(wrapper);
    }

    document.getElementById("downloadAllBtn").style.display = qrCount > 1 ? "inline-block" : "none";
  }

  // å…¨éƒ¨ä¸‹è¼‰åŠŸèƒ½
document.getElementById('downloadAllBtn').onclick = async function() {
  const wrappers = document.querySelectorAll('.qr-wrapper');
  if (!wrappers.length) return;

  // å…ˆæš«æ™‚éš±è—æ‰€æœ‰ barcode-description
  wrappers.forEach(w => {
    const desc = w.querySelector('.barcode-description');
    if (desc) desc.style.display = 'none';
  });

  const zip = new JSZip();
  for (let i = 0; i < wrappers.length; i++) {
    // ç›´æ¥å°åŸæœ¬çš„ DOM ç¯€é»åš html2canvas
    const canvas = await html2canvas(wrappers[i], { scale: 2 });
    const dataUrl = canvas.toDataURL('image/png');
    const imgData = dataUrl.split(',')[1];
    zip.file(`QRCode_${i+1}.png`, imgData, {base64: true});
  }

  // é‚„åŸé¡¯ç¤º barcode-description
  wrappers.forEach(w => {
    const desc = w.querySelector('.barcode-description');
    if (desc) desc.style.display = '';
  });

  zip.generateAsync({type: "blob"}).then(function(content) {
    saveAs(content, "QRCodes.zip");
  });
};

  function showCustomAlert(msg) {
  document.getElementById('customAlertMsg').textContent = msg;
  document.getElementById('customAlert').style.display = 'flex';
}
  function closeCustomAlert() {
    document.getElementById('customAlert').style.display = 'none';
  }
  </script>
</body>
</html>
