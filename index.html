<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>QR Code ç”¢ç”Ÿå™¨</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1rem;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    p {
      font-size: 1rem;
      font-weight: bold;
      color: red;
      text-align: center;
      margin-bottom: 1rem;
    }

    form {
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    input, select, button {
      font-size: 1rem;
      padding: 0.5rem;
      width: 100%;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }

    .qrcode-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      width: 100%;
      max-width: 1000px;
      margin-top: 1rem;
    }

    .qr-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      background-color: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .barcode-description {
      font-size: 0.9rem;
      line-height: 1.4;
      margin-top: 0.5rem;
      word-break: break-all;
    }

    @media screen and (max-width: 600px) {
      .qr-wrapper {
        width: 100%;
        align-items: center;
      }
    }
  </style>
</head>
<body>
 <div style="text-align: center; line-height: 1.8;">
  <p style="margin-bottom: 0.0em;">ğŸš€ <strong>ä½¿ç”¨é¢¨éšªæé†’</strong></p>
  <p style="margin: 0;">QRæ¢ç¢¼åªèƒ½åœ¨å…¨å®¶é™å®šä½¿ç”¨</p>
  <p style="margin: 0;">QRä¿¡ç”¨å¡æ¢ç¢¼ç”¢ç”Ÿå™¨æœ‰å¯èƒ½æœƒç™¼ç”Ÿ</p>
  <p style="margin: 0;">æ¢ç¢¼æƒå¾—éä½†å¯¦éš›æ²’å…¥å¸³</p>
  <p style="margin: 0;">ä»˜æ¬¾ç´€éŒ„ã€Œé£›åˆ°å¤–å¤ªç©ºã€ä¸è¦‹äº†çš„æƒ…æ³</p>
  <p style="margin: 0;">è«‹å‹™å¿…ç¢ºèªæ¢ç¢¼å…§å®¹æ­£ç¢ºç„¡èª¤</p>
  <p style="margin-top: 0.0em;">âš ï¸ é€™äº›é¢¨éšªéœ€ç”±æ‚¨è‡ªè¡Œæ‰¿æ“”ï¼Œè«‹å°å¿ƒä½¿ç”¨</p>
</div>

  <h2>QR Code ç”¢ç”Ÿå™¨</h2>

  <form id="barcodeForm">
    <label>ç¬¬ä¸‰æ®µæ¢ç¢¼å‰4ç¢¼</label>
    <select id="barcodeType">
      <option value="YYMM">å¹´+æœˆ</option>
      <option value="MMDD">æœˆ+æ—¥</option>
    </select>

    <label>ç¬¬ä¸€æ®µæ¢ç¢¼ (9ç¢¼)</label>
    <input type="text" id="firstBarcode" required />

    <label>ç¬¬äºŒæ®µæ¢ç¢¼ (16ç¢¼)</label>
    <input type="text" id="secondBarcode" required />

    <label>ç¹³è²»æœŸé™ (YYYMMDD)</label>
    <input type="text" id="paymentDue" required />

    <label>ç¹³è²»é‡‘é¡</label>
    <input type="text" id="paymentAmount" required />

    <label>ç”Ÿæˆ QR Code æ•¸é‡:</label>
    <select id="qrCount">
      <option value="1">1</option>
      <option value="10">10</option>
      <option value="20">20</option>
      <option value="30">30</option>
      <option value="40">40</option>
      <option value="50">50</option>
      <option value="60">60</option>
    </select>

    <button type="button" onclick="generateQRCode()">ç”Ÿæˆ QR Code</button>
  </form>

  <div class="qrcode-container" id="qrcodeContainer" style="display: none;"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // ä¿®æ­£å‡½å¼ï¼šå°‡å­—æ¯è½‰æ›ç‚ºæ•¸å­—
    function convertLettersToNumbers(text) {
        var result = "";
        for (var i = 0; i < text.length; i++) {
            var char = text.charAt(i);
            if (char >= 'A' && char <= 'Z') {
                result += convertLetterToNumber(char);
            } else if (!isNaN(char)) {
                result += char;
            } else {
                console.error(`ç„¡æ³•è§£æå­—å…ƒ: ${char}`);
            }
        }
        return result;
    }

    // ä¿®æ­£å‡½å¼ï¼šå–®å€‹å­—æ¯è½‰æ›ç‚ºæ•¸å­—
    function convertLetterToNumber(letter) {
        var mapping = {
            'A': '1', 'B': '2', 'C': '3', 'D': '4', 'E': '5',
            'F': '6', 'G': '7', 'H': '8', 'I': '9', 'J': '1',
            'K': '2', 'L': '3', 'M': '4', 'N': '5', 'O': '6',
            'P': '7', 'Q': '8', 'R': '9', 'S': '2', 'T': '3',
            'U': '4', 'V': '5', 'W': '6', 'X': '7', 'Y': '8', 'Z': '9'
        };
        return mapping[letter] || '0'; // è‹¥å­—æ¯ä¸åœ¨ç¯„åœå…§ï¼Œå›å‚³ '0'
    }

    // ä¿®æ­£å‡½å¼ï¼šè¨ˆç®—å¥‡æ•¸ä½ç½®æ•¸å­—ç¸½å’Œ
    function calculateOddSum(barcode) {
        var sum = 0;
        for (var i = 0; i < barcode.length; i += 2) {
            var char = barcode.charAt(i);
            if (!isNaN(char)) {
                sum += parseInt(char, 10);
            } else {
                console.error(`å¥‡æ•¸ä½ç½®åŒ…å«éæ•¸å­—å­—å…ƒ: ${char}`);
            }
        }
        return sum;
    }

    // ä¿®æ­£å‡½å¼ï¼šè¨ˆç®—å¶æ•¸ä½ç½®æ•¸å­—ç¸½å’Œ
    function calculateEvenSum(barcode) {
        var sum = 0;
        for (var i = 1; i < barcode.length; i += 2) {
            var char = barcode.charAt(i);
            if (!isNaN(char)) {
                sum += parseInt(char, 10);
            } else {
                console.error(`å¶æ•¸ä½ç½®åŒ…å«éæ•¸å­—å­—å…ƒ: ${char}`);
            }
        }
        return sum;
    }

    // ä¿®æ­£æ¢ç¢¼ç”Ÿæˆé‚è¼¯
    function generateQRCode() {
        const firstBarcode = document.getElementById("firstBarcode").value.trim();
        const secondBarcode = document.getElementById("secondBarcode").value.trim();
        const paymentDue = document.getElementById("paymentDue").value.trim();
        const paymentAmount = document.getElementById("paymentAmount").value.trim();
        const barcodeType = document.getElementById("barcodeType").value;
        const qrCount = parseInt(document.getElementById("qrCount").value);

        if (!firstBarcode || !secondBarcode || !paymentDue || !paymentAmount || isNaN(qrCount)) {
            alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼");
            return;
        }

        const container = document.getElementById("qrcodeContainer");
        container.innerHTML = "";
        container.style.display = "flex";

        let currentDate = new Date(
            parseInt(paymentDue.substring(0, 3), 10) + 1911,
            parseInt(paymentDue.substring(3, 5), 10) - 1,
            parseInt(paymentDue.substring(5, 7), 10)
        );

          for (let i = 0; i < qrCount; i++) {
            let formattedDate;
        
            if (barcodeType === "YYMM") {
              if (i === 0) {
                // é¦–ç­†ä½¿ç”¨è¼¸å…¥çš„ç¹³è²»æœŸé™
                formattedDate = paymentDue;
              } else {
                // å…¶ä»–ç­†ç‚ºæ¯æœˆç¬¬ä¸€å¤©
                currentDate.setMonth(currentDate.getMonth() + 1);
                formattedDate =
                  `${String(currentDate.getFullYear() - 1911).padStart(3, "0")}${String(currentDate.getMonth() + 1).padStart(2, "0")}01`;
              }
            } else {
              formattedDate =
                `${String(currentDate.getFullYear() - 1911).padStart(3, "0")}${String(currentDate.getMonth() + 1).padStart(2, "0")}${String(currentDate.getDate()).padStart(2, "0")}`;
              currentDate.setDate(currentDate.getDate() + 1);
            }

            const convertedFirst = convertLettersToNumbers(firstBarcode);
            const convertedSecond = convertLettersToNumbers(secondBarcode);
            const datePart = barcodeType === "YYMM" ? formattedDate.substring(1, 5) : formattedDate.substring(3);
            const paddedAmount = paymentAmount.padStart(9, "0");

            const oddSum = calculateOddSum(convertedFirst) + calculateOddSum(convertedSecond) + calculateOddSum(datePart + paddedAmount);
            const evenSum = calculateEvenSum(convertedFirst) + calculateEvenSum(convertedSecond) + calculateEvenSum(datePart + paddedAmount);

            const oddChecksum = oddSum % 11 === 0 ? "A" : oddSum % 11 === 10 ? "B" : oddSum % 11;
            const evenChecksum = evenSum % 11 === 0 ? "X" : evenSum % 11 === 10 ? "Y" : evenSum % 11;

            const thirdBarcode = datePart + oddChecksum + evenChecksum + paddedAmount;
            const qrData = `FAMI||{"bar1":"${firstBarcode}","bar2":"${secondBarcode}","bar3":"${thirdBarcode}","ID":"3A01"}`;

            const qrWrapper = document.createElement("div");
            qrWrapper.className = "qr-wrapper";

            const header = document.createElement("div");
            header.style.display = "flex";
            header.style.justifyContent = "space-between";
            header.style.width = "100%";

            const idLabel = document.createElement("div");
            idLabel.textContent = `è¶…å•†ç¹³è²»æ¢ç¢¼_${i + 1}`;
            idLabel.style.fontWeight = "bold";

            const downloadBtn = document.createElement("div");
            downloadBtn.textContent = "åœ–æª”ä¸‹è¼‰";
            downloadBtn.style.color = "red";
            downloadBtn.style.cursor = "pointer";
            downloadBtn.style.fontWeight = "bold";

            downloadBtn.onclick = () => {
                const cleanWrapper = document.createElement("div");
                cleanWrapper.style.display = "flex";
                cleanWrapper.style.flexDirection = "column";
                cleanWrapper.style.alignItems = "center";
                cleanWrapper.style.padding = "10px";
                cleanWrapper.style.border = "1px solid #ccc";
                cleanWrapper.style.borderRadius = "8px";
                cleanWrapper.style.backgroundColor = "#fff";

                const idText = document.createElement("div");
                idText.textContent = idLabel.textContent;
                idText.style.fontWeight = "bold";
                cleanWrapper.appendChild(idText);

                const qrCanvas = qrWrapper.querySelector("canvas");
                if (qrCanvas) {
                    const qrClone = qrCanvas.cloneNode(true);
                    cleanWrapper.appendChild(qrClone);
                }

                const tempContainer = document.createElement("div");
                tempContainer.style.position = "fixed";
                tempContainer.style.left = "-9999px";
                document.body.appendChild(tempContainer);
                tempContainer.appendChild(cleanWrapper);

                html2canvas(cleanWrapper, { scale: 2 }).then(canvas => {
                    const link = document.createElement("a");
                    link.download = `${idLabel.textContent}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    document.body.removeChild(tempContainer);
                });
            };

            header.appendChild(idLabel);
            header.appendChild(downloadBtn);
            qrWrapper.appendChild(header);

            const qrDiv = document.createElement("div");
            new QRCode(qrDiv, { text: qrData, width: 150, height: 150 });
            qrWrapper.appendChild(qrDiv);

            const desc = document.createElement("div");
            desc.className = "barcode-description";
            desc.innerHTML = `<div>${firstBarcode}</div><div>${secondBarcode}</div><div>${thirdBarcode}</div>`;
            qrWrapper.appendChild(desc);

            container.appendChild(qrWrapper);
        }
    }
  </script>
</body>
</html>
